worker_processes ${{NUM_WORKERS}};
error_log stderr notice;
daemon off;
pid logs/nginx.pid;

env JWT_SECRET="${{AUTH_SECRET}}";
env JWT_SECRET_IS_BASE64_ENCODED=true;

events {
  worker_connections 1024;
}

http {
  include src/cosy/server/mime.types;

  server {
    listen ${{PORT}};
    lua_code_cache ${{CODE_CACHE}};
    root "${{WWW_PREFIX}}";

    location / {
      default_type application/json;
      access_by_lua '
        if ngx.var.http_Authorization then
          local jwt = require "nginx-jwt"
          jwt.auth ()
        end
      ';
      content_by_lua '
        require "lapis".serve "cosy.server.app"
      ';
    }

    location /static/ {
      alias static/;
    }

    location /js {
      alias "${{WWW_PREFIX}}/js";
      autoindex on;
    }
    location /css {
      alias "${{WWW_PREFIX}}/css";
      autoindex on;
    }
    location /fonts {
      alias "${{WWW_PREFIX}}/fonts";
      autoindex on;
    }
    location /favicon.png {
      alias static/favicon.png;
    }
  }
}
