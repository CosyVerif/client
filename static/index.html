<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
          name="viewport" />
    <link rel="icon"
          href="/favicon.png"
          type="image/png" />
    <link href="/css/bootstrap.min.css"
          rel="stylesheet"
          type="text/css" />
    <link href="/css/bootstrap-theme.min.css"
          rel="stylesheet"
          type="text/css" />
    <link href="/css/font-awesome.min.css"
          rel="stylesheet"
          type="text/css" />
    <title>CosyVerif</title>
  </head>
  <body>
    <div id="headbar"></div>
    <div class="container-fluid main-content">
      <div class="row">
        <div id="main"></div>
      </div>
    </div>

    <script type="text/lua"
            lang="lua">
      -- This script puts up a working Lua environment,
      -- by defining a "require" usable with asynchronous JavaScript.
      local js      = _G.js
      local window  = _G.js.global

      function _G.require (name)
        local loaded = package.loaded [name]
        if loaded then
          return loaded
        end
        local errors = {}
        for _, searcher in ipairs (package.searchers) do
          local factory, path = searcher (name)
          if type (factory) == "function" then
            local result = factory (name)
            package.loaded [name] = result
            return result
          else
            errors [#errors+1] = path
          end
        end
        errors = table.concat (errors, "\n")
        error (errors)
      end

      function _G.request (t, opt)
        if type (t) == "string" then
          opt     = opt or {}
          opt.url = t
          t       = opt
        end
        local co      = coroutine.running ()
        local promise = window:fetch (t.url, t)
        promise ["then"] (promise, function (_, response)
          coroutine.resume (co, response)
        end)
        local response = coroutine.yield ()
        if response.ok then
          promise = response:text ()
          promise ["then"] (promise, function (_, value)
            coroutine.resume (co, value)
          end)
          return coroutine.yield (), response.status
        else
          return nil, response.status
        end
      end

      table.insert (package.searchers, 2, function (name)
        local url = window.location.origin .. "/lua/" .. name
        local result, err = _G.request (url)
        if not result then
          error (err)
        end
        return load (result, url)
      end)
    </script>

    <script type="text/lua"
            lang="lua">
      local js      = _G.js
      local window  = js.global
      local co = coroutine.create (function ()
        xpcall (function ()
          local Coromake = require "coroutine.make"
        end, function (err)
          print ("error:", err)
          print (debug.traceback ())
        end)
      end)
      coroutine.resume (co)
    </script>

    <script src="/js/jquery.min.js"
            type="text/javascript">
    </script>
    <script src="/js/fetch.js"
            type="text/javascript">
    </script>
    <script src="http://cdn.auth0.com/js/lock-9.min.js"
            type="text/javascript"
            async defer>
    </script>

    <script src="/js/bootstrap.min.js"
            type="text/javascript"
            async defer>
    </script>
    <script src="/js/locationpicker.jquery.min.js"
            type="text/javascript"
            async defer>
    </script>
    <script src="/js/bootbox.min.js"
            type="text/javascript"
            async defer>
    </script>
    <script src="/js/lua.vm.js"
            type="text/javascript"
            async defer>
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3&libraries=places"
            type="text/javascript"
            async defer>
    </script>
    <script src="https://www.google.com/recaptcha/api.js?render=explicit"
            type="text/javascript"
            async defer>
    </script>
  </body>
</html>
